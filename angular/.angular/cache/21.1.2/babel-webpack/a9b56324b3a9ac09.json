{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/bagia/Desktop/S1/notes cours/Web/VersionMax/Web-Sampler-cours-2/Web-Sampler-deploiment/angular/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { ActivatedRoute, Router } from '@angular/router';\nimport { PresetsService, Preset, PresetSample } from '../presets.service';\nimport { appendAudioFiles, buildSamplesFromUpload, buildSamplesFromUrls, validateUrlSamples } from '../preset-audio-utils';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"../presets.service\";\nfunction ModifySamplerComponent_ng_container_8_li_2_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r2 = i0.ɵɵgetCurrentView();\n    i0.ɵɵdomElementStart(0, \"li\")(1, \"div\", 19)(2, \"strong\");\n    i0.ɵɵtext(3);\n    i0.ɵɵdomElementEnd();\n    i0.ɵɵdomElementStart(4, \"small\", 9);\n    i0.ɵɵtext(5);\n    i0.ɵɵdomElementEnd()();\n    i0.ɵɵdomElementStart(6, \"button\", 20);\n    i0.ɵɵdomListener(\"click\", function ModifySamplerComponent_ng_container_8_li_2_Template_button_click_6_listener() {\n      const i_r3 = i0.ɵɵrestoreView(_r2).index;\n      const ctx_r3 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r3.removeExistingSample(i_r3));\n    });\n    i0.ɵɵtext(7, \"\\u2715\");\n    i0.ɵɵdomElementEnd()();\n  }\n  if (rf & 2) {\n    const s_r5 = ctx.$implicit;\n    const i_r3 = ctx.index;\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(s_r5.name || \"Son \" + (i_r3 + 1));\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(s_r5.url);\n  }\n}\nfunction ModifySamplerComponent_ng_container_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵdomElementContainerStart(0);\n    i0.ɵɵdomElementStart(1, \"ul\", 17);\n    i0.ɵɵdomTemplate(2, ModifySamplerComponent_ng_container_8_li_2_Template, 8, 2, \"li\", 18);\n    i0.ɵɵdomElementEnd();\n    i0.ɵɵdomElementContainerEnd();\n  }\n  if (rf & 2) {\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(2);\n    i0.ɵɵdomProperty(\"ngForOf\", ctx_r3.existingSamples);\n  }\n}\nfunction ModifySamplerComponent_ng_template_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵdomElementStart(0, \"p\", 9);\n    i0.ɵɵtext(1, \"Aucun son pour ce preset.\");\n    i0.ɵɵdomElementEnd();\n  }\n}\nfunction ModifySamplerComponent_ul_23_li_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r7 = i0.ɵɵgetCurrentView();\n    i0.ɵɵdomElementStart(0, \"li\")(1, \"span\");\n    i0.ɵɵtext(2);\n    i0.ɵɵdomElementEnd();\n    i0.ɵɵdomElementStart(3, \"button\", 20);\n    i0.ɵɵdomListener(\"click\", function ModifySamplerComponent_ul_23_li_1_Template_button_click_3_listener() {\n      const i_r8 = i0.ɵɵrestoreView(_r7).index;\n      const ctx_r3 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r3.removeNewFile(i_r8));\n    });\n    i0.ɵɵtext(4, \" \\u2715 \");\n    i0.ɵɵdomElementEnd()();\n  }\n  if (rf & 2) {\n    const file_r9 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(file_r9.name);\n  }\n}\nfunction ModifySamplerComponent_ul_23_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵdomElementStart(0, \"ul\", 17);\n    i0.ɵɵdomTemplate(1, ModifySamplerComponent_ul_23_li_1_Template, 5, 1, \"li\", 18);\n    i0.ɵɵdomElementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r3 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵdomProperty(\"ngForOf\", ctx_r3.files);\n  }\n}\nfunction ModifySamplerComponent_div_29_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵdomElementStart(0, \"div\", 9);\n    i0.ɵɵtext(1, \"Sauvegarde en cours\\u2026\");\n    i0.ɵɵdomElementEnd();\n  }\n}\nexport let ModifySamplerComponent = /*#__PURE__*/(() => {\n  class ModifySamplerComponent {\n    constructor(route, svc, router) {\n      this.route = route;\n      this.svc = svc;\n      this.router = router;\n      // propriétés du composant\n      // pour gérer le nom, les fichiers, les samples existants, l'état de chargement, etc.\n      this.originalName = '';\n      this.name = '';\n      this.urlText = '';\n      this.existingSamples = [];\n      this.files = [];\n      this.isDragOver = false;\n      this.loading = false;\n      this.loadedPreset = null;\n    }\n    // fonction d'initialisation du composant\n    // s'active au chargement de la page\n    ngOnInit() {\n      const routeName = this.route.snapshot.paramMap.get('name');\n      if (!routeName) {\n        alert('Aucun preset spécifié.');\n        this.router.navigate(['/']);\n        return;\n      }\n      this.loadPreset(routeName);\n    }\n    // fonction de chargement du preset depuis le back end\n    loadPreset(name) {\n      this.loading = true;\n      this.svc.getOne(name).subscribe({\n        next: p => {\n          this.loadedPreset = p;\n          this.originalName = p.name;\n          this.name = p.name;\n          this.existingSamples = Array.isArray(p.samples) ? [...p.samples] : [];\n          this.loading = false;\n        },\n        error: e => {\n          console.error(e);\n          alert('Impossible de charger le preset.');\n          this.loading = false;\n          this.router.navigate(['/']);\n        }\n      });\n    }\n    // gestion des fichiers audio sélectionnés,\n    // on verefie qu'ils sont bien audio avant de les ajouter\n    // et on limite à 16 fichiers max\n    onFileSelected(event) {\n      const input = event.target;\n      if (!input.files) {\n        return;\n      }\n      const selected = [];\n      for (let i = 0; i < input.files.length; i++) {\n        const f = input.files.item(i);\n        if (f && f.type.startsWith('audio/')) selected.push(f);\n      }\n      if (!selected.length) {\n        return;\n      }\n      const {\n        files,\n        truncated\n      } = appendAudioFiles(this.files, selected, 16);\n      this.files = files;\n      if (truncated) {\n        alert('Maximum 16 fichiers audio par preset. Les fichiers supplémentaires ont été ignorés.');\n      }\n    }\n    // gestion du drag and drop\n    // pour les fichiers audio\n    onDragOver(event) {\n      event.preventDefault();\n      this.isDragOver = true;\n    }\n    // gestion du drag and drop\n    // pour les fichiers audio\n    onDragLeave(event) {\n      event.preventDefault();\n      this.isDragOver = false;\n    }\n    // gestion du drop de fichiers, \n    // ajout des fichiers audio avec la même logique que la sélection\n    // et on limite à 16 fichiers max encore une fois\n    onDrop(event) {\n      event.preventDefault();\n      this.isDragOver = false;\n      if (!event.dataTransfer) {\n        return;\n      }\n      const droppedFiles = [];\n      if (event.dataTransfer.files && event.dataTransfer.files.length) {\n        for (let i = 0; i < event.dataTransfer.files.length; i++) {\n          const f = event.dataTransfer.files.item(i);\n          if (f && f.type.startsWith('audio/')) droppedFiles.push(f);\n        }\n      }\n      if (!droppedFiles.length) {\n        return;\n      }\n      const {\n        files,\n        truncated\n      } = appendAudioFiles(this.files, droppedFiles, 16);\n      this.files = files;\n      if (truncated) {\n        alert('Maximum 16 fichiers audio par preset. Les fichiers supplémentaires ont été ignorés.');\n      }\n    }\n    // splices permet de retirer un fichier a partir de son index\n    removeNewFile(index) {\n      this.files.splice(index, 1);\n      this.files = [...this.files];\n    }\n    // splices permet de retirer un sample existant a partir de son index\n    removeExistingSample(index) {\n      this.existingSamples.splice(index, 1);\n      this.existingSamples = [...this.existingSamples];\n    }\n    // fonction de sauvegarde du preset modifié\n    //construction du preset avec les nouveaux fichiers et URLs\n    // validation des URLs\n    // gestion des erreurs et alertes utilisateur\n    save() {\n      var _this = this;\n      // on recupère et valide le nom\n      const rawName = (this.name || '').trim();\n      if (!rawName) {\n        alert('Veuillez saisir un nom de preset.');\n        return;\n      }\n      const name = rawName;\n      // on recupère les URLs une par une\n      const manualUrls = (this.urlText || '').split(/\\r?\\n/).map(l => l.trim()).filter(l => !!l);\n      this.loading = true;\n      // on vérifie que le nom n'existe pas déjà (sauf si c'est le même preset)\n      this.svc.list().subscribe({\n        next: function () {\n          var _ref = _asyncToGenerator(function* (presets) {\n            const exists = (presets || []).some(p => (p.name || '').toLowerCase() === name.toLowerCase() && p.name !== _this.originalName);\n            if (exists) {\n              alert('Un autre preset avec ce nom existe déjà.');\n              _this.loading = false;\n              return;\n            }\n            // on vérifie si on a des fichiers à uploader\n            const hasFiles = _this.files && _this.files.length > 0;\n            const urlSamples = buildSamplesFromUrls(manualUrls);\n            // on valide les URLs\n            if (urlSamples.length) {\n              const invalidUrl = yield validateUrlSamples(urlSamples);\n              if (invalidUrl) {\n                alert(`Impossible de sauvegarder le preset : l'URL \"${invalidUrl}\" ne pointe pas vers un fichier audio valide sur le serveur.`);\n                _this.loading = false;\n                return;\n              }\n            }\n            const keepType = _this.loadedPreset?.type || 'Custom';\n            const keepFactory = _this.loadedPreset?.isFactoryPresets ?? false;\n            // Cas A: pas de nouveaux fichiers, on ne fait que combiner existants + URLs\n            if (!hasFiles) {\n              // on combine les samples existants et les nouveaux URLs\n              let samples = [..._this.existingSamples, ...urlSamples];\n              if (samples.length > 16) {\n                samples = samples.slice(0, 16);\n                alert('Maximum 16 sons par preset. Certains sons supplémentaires ont été ignorés.');\n              }\n              // on construit le preset complet\n              const body = {\n                name,\n                type: samples.length === 0 ? 'Empty' : keepType,\n                isFactoryPresets: keepFactory,\n                samples\n              };\n              // on envoie la mise à jour au back end  \n              // avec la gestion des erreurs\n              _this.svc.update(_this.originalName, body).subscribe({\n                next: () => {\n                  alert('Preset mis à jour.');\n                  _this.loading = false;\n                  _this.router.navigate(['/']);\n                },\n                error: e => {\n                  _this.loading = false;\n                  alert('Erreur lors de la mise à jour du preset: ' + (e?.error?.error || e?.message || e));\n                }\n              });\n              return;\n            }\n            // Cas B: nouveaux fichiers (avec éventuellement des URLs en plus)\n            const folderForUpload = _this.originalName || name;\n            _this.svc.upload(folderForUpload, _this.files).subscribe({\n              next: uploadRes => {\n                const fileSamples = buildSamplesFromUpload(folderForUpload, uploadRes);\n                let allSamples = [..._this.existingSamples, ...fileSamples, ...urlSamples];\n                if (allSamples.length > 16) {\n                  allSamples = allSamples.slice(0, 16);\n                  alert('Maximum 16 sons par preset. Certains sons supplémentaires ont été ignorés.');\n                }\n                // on construit le preset complet\n                const body = {\n                  name,\n                  type: allSamples.length === 0 ? 'Empty' : keepType,\n                  isFactoryPresets: keepFactory,\n                  samples: allSamples\n                };\n                // on envoie la mise à jour au back end  \n                // avec la gestion des erreurs\n                _this.svc.update(_this.originalName, body).subscribe({\n                  next: () => {\n                    alert('Preset mis à jour avec les nouveaux sons.');\n                    _this.loading = false;\n                    _this.router.navigate(['/']);\n                  },\n                  error: e => {\n                    _this.loading = false;\n                    alert('Erreur lors de la mise à jour du preset: ' + (e?.error?.error || e?.message || e));\n                  }\n                });\n              },\n              error: e => {\n                console.error(e);\n                _this.loading = false;\n                alert('Erreur lors de l\\'upload des fichiers audio: ' + (e?.error?.error || e?.message || e));\n              }\n            });\n          });\n          return function next(_x) {\n            return _ref.apply(this, arguments);\n          };\n        }(),\n        error: err => {\n          console.error(err);\n          this.loading = false;\n          alert('Impossible de vérifier les presets existants.');\n        }\n      });\n    }\n    static {\n      this.ɵfac = function ModifySamplerComponent_Factory(__ngFactoryType__) {\n        return new (__ngFactoryType__ || ModifySamplerComponent)(i0.ɵɵdirectiveInject(i1.ActivatedRoute), i0.ɵɵdirectiveInject(i2.PresetsService), i0.ɵɵdirectiveInject(i1.Router));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: ModifySamplerComponent,\n        selectors: [[\"app-modify-sampler\"]],\n        decls: 30,\n        vars: 10,\n        consts: [[\"noSamples\", \"\"], [\"fileInput\", \"\"], [1, \"example-flex-container\"], [\"for\", \"preset-name\", 1, \"field-label\"], [\"id\", \"preset-name\", \"type\", \"text\", \"placeholder\", \"Nom du preset\", 3, \"ngModelChange\", \"ngModel\"], [4, \"ngIf\", \"ngIfElse\"], [\"for\", \"preset-urls\", 1, \"field-label\"], [\"id\", \"preset-urls\", \"rows\", \"3\", \"placeholder\", \"Ex: ./MonPreset/nouveau-kick.wav\", 3, \"ngModelChange\", \"ngModel\"], [1, \"drop-zone\", 3, \"drop\", \"dragover\", \"dragleave\"], [1, \"muted\"], [\"type\", \"button\", 1, \"action\", \"secondary\", 3, \"click\"], [\"type\", \"file\", \"multiple\", \"\", \"accept\", \"audio/*\", \"hidden\", \"\", 3, \"change\"], [\"class\", \"file-list\", 4, \"ngIf\"], [1, \"example-button-row\"], [1, \"action\", 3, \"click\", \"disabled\"], [\"routerLink\", \"/\", 1, \"action\", \"secondary\", 3, \"disabled\"], [\"class\", \"muted\", 4, \"ngIf\"], [1, \"file-list\"], [4, \"ngFor\", \"ngForOf\"], [1, \"file-info\"], [\"type\", \"button\", 1, \"chip-remove\", 3, \"click\"]],\n        template: function ModifySamplerComponent_Template(rf, ctx) {\n          if (rf & 1) {\n            const _r1 = i0.ɵɵgetCurrentView();\n            i0.ɵɵdomElementStart(0, \"div\", 2)(1, \"h2\");\n            i0.ɵɵtext(2, \"Modifier le preset\");\n            i0.ɵɵdomElementEnd();\n            i0.ɵɵdomElementStart(3, \"label\", 3);\n            i0.ɵɵtext(4, \"Nom du preset\");\n            i0.ɵɵdomElementEnd();\n            i0.ɵɵdomElementStart(5, \"input\", 4);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function ModifySamplerComponent_Template_input_ngModelChange_5_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              i0.ɵɵtwoWayBindingSet(ctx.name, $event) || (ctx.name = $event);\n              return i0.ɵɵresetView($event);\n            });\n            i0.ɵɵdomElementEnd();\n            i0.ɵɵdomElementStart(6, \"h3\");\n            i0.ɵɵtext(7, \"Sons existants\");\n            i0.ɵɵdomElementEnd();\n            i0.ɵɵdomTemplate(8, ModifySamplerComponent_ng_container_8_Template, 3, 1, \"ng-container\", 5)(9, ModifySamplerComponent_ng_template_9_Template, 2, 0, \"ng-template\", null, 0, i0.ɵɵtemplateRefExtractor);\n            i0.ɵɵdomElementStart(11, \"label\", 6);\n            i0.ɵɵtext(12, \"Nouvelles URLs de sons (une par ligne, optionnel)\");\n            i0.ɵɵdomElementEnd();\n            i0.ɵɵdomElementStart(13, \"textarea\", 7);\n            i0.ɵɵtwoWayListener(\"ngModelChange\", function ModifySamplerComponent_Template_textarea_ngModelChange_13_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              i0.ɵɵtwoWayBindingSet(ctx.urlText, $event) || (ctx.urlText = $event);\n              return i0.ɵɵresetView($event);\n            });\n            i0.ɵɵdomElementEnd();\n            i0.ɵɵdomElementStart(14, \"div\", 8);\n            i0.ɵɵdomListener(\"drop\", function ModifySamplerComponent_Template_div_drop_14_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.onDrop($event));\n            })(\"dragover\", function ModifySamplerComponent_Template_div_dragover_14_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.onDragOver($event));\n            })(\"dragleave\", function ModifySamplerComponent_Template_div_dragleave_14_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.onDragLeave($event));\n            });\n            i0.ɵɵdomElementStart(15, \"p\");\n            i0.ɵɵtext(16, \"Ajouter de nouveaux fichiers audio\");\n            i0.ɵɵdomElementEnd();\n            i0.ɵɵdomElementStart(17, \"p\", 9);\n            i0.ɵɵtext(18, \"Glissez-d\\u00E9posez ici ou\");\n            i0.ɵɵdomElementEnd();\n            i0.ɵɵdomElementStart(19, \"button\", 10);\n            i0.ɵɵdomListener(\"click\", function ModifySamplerComponent_Template_button_click_19_listener() {\n              i0.ɵɵrestoreView(_r1);\n              const fileInput_r6 = i0.ɵɵreference(22);\n              return i0.ɵɵresetView(fileInput_r6.click());\n            });\n            i0.ɵɵtext(20, \" Parcourir le PC\\u2026 \");\n            i0.ɵɵdomElementEnd();\n            i0.ɵɵdomElementStart(21, \"input\", 11, 1);\n            i0.ɵɵdomListener(\"change\", function ModifySamplerComponent_Template_input_change_21_listener($event) {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.onFileSelected($event));\n            });\n            i0.ɵɵdomElementEnd()();\n            i0.ɵɵdomTemplate(23, ModifySamplerComponent_ul_23_Template, 2, 1, \"ul\", 12);\n            i0.ɵɵdomElementStart(24, \"div\", 13)(25, \"button\", 14);\n            i0.ɵɵdomListener(\"click\", function ModifySamplerComponent_Template_button_click_25_listener() {\n              i0.ɵɵrestoreView(_r1);\n              return i0.ɵɵresetView(ctx.save());\n            });\n            i0.ɵɵtext(26, \" Enregistrer les modifications \");\n            i0.ɵɵdomElementEnd();\n            i0.ɵɵdomElementStart(27, \"button\", 15);\n            i0.ɵɵtext(28, \" Annuler \");\n            i0.ɵɵdomElementEnd()();\n            i0.ɵɵdomTemplate(29, ModifySamplerComponent_div_29_Template, 2, 0, \"div\", 16);\n            i0.ɵɵdomElementEnd();\n          }\n          if (rf & 2) {\n            const noSamples_r10 = i0.ɵɵreference(10);\n            i0.ɵɵadvance(5);\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.name);\n            i0.ɵɵadvance(3);\n            i0.ɵɵdomProperty(\"ngIf\", ctx.existingSamples.length)(\"ngIfElse\", noSamples_r10);\n            i0.ɵɵadvance(5);\n            i0.ɵɵtwoWayProperty(\"ngModel\", ctx.urlText);\n            i0.ɵɵadvance();\n            i0.ɵɵclassProp(\"over\", ctx.isDragOver);\n            i0.ɵɵadvance(9);\n            i0.ɵɵdomProperty(\"ngIf\", ctx.files.length);\n            i0.ɵɵadvance(2);\n            i0.ɵɵdomProperty(\"disabled\", ctx.loading);\n            i0.ɵɵadvance(2);\n            i0.ɵɵdomProperty(\"disabled\", ctx.loading);\n            i0.ɵɵadvance(2);\n            i0.ɵɵdomProperty(\"ngIf\", ctx.loading);\n          }\n        },\n        styles: [\".example-flex-container[_ngcontent-%COMP%]{margin-top:4px;display:flex;flex-direction:column;gap:12px}.field-label[_ngcontent-%COMP%]{font-size:.9rem;font-weight:500}input[type=text][_ngcontent-%COMP%], textarea[_ngcontent-%COMP%]{width:100%;padding:8px 10px;border-radius:4px;border:1px solid rgba(0,0,0,.15);font:inherit;box-sizing:border-box}.drop-zone[_ngcontent-%COMP%]{margin-top:8px;padding:16px;border-radius:6px;border:2px dashed rgba(0,0,0,.2);text-align:center;cursor:pointer;transition:background-color .15s ease,border-color .15s ease}.drop-zone.over[_ngcontent-%COMP%]{background-color:#00000008;border-color:#0006}.file-list[_ngcontent-%COMP%]{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:6px}.file-list[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:4px 8px;border-radius:6px;background:#0000000a;font-size:.85rem}.file-info[_ngcontent-%COMP%]{display:flex;flex-direction:column}.chip-remove[_ngcontent-%COMP%]{border:none;background:transparent;cursor:pointer;padding:0 2px;font-size:.9rem}\"]\n      });\n    }\n  }\n  return ModifySamplerComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}