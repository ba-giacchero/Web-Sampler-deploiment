{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/bagia/Desktop/S1/notes cours/Web/VersionMax/Web-Sampler-cours-2/Web-Sampler-deploiment/angular/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { Router } from '@angular/router';\nimport { PresetsService, Preset, PresetSample } from '../presets.service';\nimport { appendAudioFiles, buildSamplesFromUpload, buildSamplesFromUrls, validateUrlSamples } from '../preset-audio-utils';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"../presets.service\";\nimport * as i2 from \"@angular/router\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"@angular/forms\";\nfunction CreateSamplerComponent_ul_18_li_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r3 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"li\")(1, \"span\");\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"button\", 17);\n    i0.ɵɵlistener(\"click\", function CreateSamplerComponent_ul_18_li_1_Template_button_click_3_listener() {\n      const i_r4 = i0.ɵɵrestoreView(_r3).index;\n      const ctx_r4 = i0.ɵɵnextContext(2);\n      return i0.ɵɵresetView(ctx_r4.removeFile(i_r4));\n    });\n    i0.ɵɵtext(4, \" \\u2715 \");\n    i0.ɵɵelementEnd()();\n  }\n  if (rf & 2) {\n    const file_r6 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(file_r6.name);\n  }\n}\nfunction CreateSamplerComponent_ul_18_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"ul\", 15);\n    i0.ɵɵtemplate(1, CreateSamplerComponent_ul_18_li_1_Template, 5, 1, \"li\", 16);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const ctx_r4 = i0.ɵɵnextContext();\n    i0.ɵɵadvance();\n    i0.ɵɵproperty(\"ngForOf\", ctx_r4.files);\n  }\n}\nfunction CreateSamplerComponent_div_24_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 7);\n    i0.ɵɵtext(1, \"Cr\\u00E9ation du preset en cours\\u2026\");\n    i0.ɵɵelementEnd();\n  }\n}\nexport let CreateSamplerComponent = /*#__PURE__*/(() => {\n  class CreateSamplerComponent {\n    svc;\n    router;\n    name = '';\n    urlText = '';\n    files = [];\n    isDragOver = false;\n    loading = false;\n    constructor(svc, router) {\n      this.svc = svc;\n      this.router = router;\n    }\n    // gestion de la sélection de fichiers, \n    // on verifie qu'ils sont bien audio avant de les ajouter\n    //et on limite à 16 fichiers max\n    onFileSelected(event) {\n      const input = event.target;\n      if (!input.files) {\n        return;\n      }\n      const selected = [];\n      for (let i = 0; i < input.files.length; i++) {\n        const f = input.files.item(i);\n        if (f && f.type.startsWith('audio/')) selected.push(f);\n      }\n      if (!selected.length) {\n        return;\n      }\n      const {\n        files,\n        truncated\n      } = appendAudioFiles(this.files, selected, 16);\n      this.files = files;\n      if (truncated) {\n        alert('Maximum 16 fichiers audio par preset. Les fichiers supplémentaires ont été ignorés.');\n      }\n    }\n    // gestion du drag over pour le drop de fichiers audio\n    onDragOver(event) {\n      event.preventDefault();\n      this.isDragOver = true;\n    }\n    // gestion du drag leave pour le drop de fichiers audio\n    onDragLeave(event) {\n      event.preventDefault();\n      this.isDragOver = false;\n    }\n    // gestion du drop de fichiers, ajout des fichiers audio avec la même logique que la sélection\n    onDrop(event) {\n      event.preventDefault();\n      this.isDragOver = false;\n      if (!event.dataTransfer) {\n        return;\n      }\n      const droppedFiles = [];\n      if (event.dataTransfer.files && event.dataTransfer.files.length) {\n        for (let i = 0; i < event.dataTransfer.files.length; i++) {\n          const f = event.dataTransfer.files.item(i);\n          if (f && f.type.startsWith('audio/')) droppedFiles.push(f);\n        }\n      }\n      // gestion du drop de fichiers audio qui limite à 16 fichiers max\n      if (!droppedFiles.length) {\n        return;\n      }\n      const {\n        files,\n        truncated\n      } = appendAudioFiles(this.files, droppedFiles, 16);\n      this.files = files;\n      if (truncated) {\n        alert('Maximum 16 fichiers audio par preset. Les fichiers supplémentaires ont été ignorés.');\n      }\n    }\n    //delete d'un fichier sélectionné\n    removeFile(index) {\n      this.files.splice(index, 1);\n      this.files = [...this.files];\n    }\n    // création du preset\n    createPreset() {\n      var _this = this;\n      // on recupère et valide le nom\n      const rawName = (this.name || '').trim();\n      if (!rawName) {\n        alert('Veuillez saisir un nom de preset.');\n        return;\n      }\n      const name = rawName;\n      // on recupère les URLs une par une\n      const manualUrls = (this.urlText || '').split(/\\r?\\n/).map(l => l.trim()).filter(l => !!l);\n      this.loading = true;\n      this.svc.list().subscribe({\n        next: function () {\n          var _ref = _asyncToGenerator(function* (presets) {\n            //on verifie que le nom n'existe pas déjà\n            const exists = (presets || []).some(p => (p.name || '').toLowerCase() === name.toLowerCase());\n            if (exists) {\n              alert('Un preset avec ce nom existe déjà.');\n              _this.loading = false;\n              return;\n            }\n            const hasFiles = _this.files && _this.files.length > 0;\n            const urlSamples = buildSamplesFromUrls(manualUrls);\n            // Si des URLs sont fournies, on vérifie qu'elles pointent bien vers des fichiers audio accessibles\n            if (urlSamples.length) {\n              const invalidUrl = yield validateUrlSamples(urlSamples);\n              if (invalidUrl) {\n                alert(`Impossible de créer le preset : l'URL \"${invalidUrl}\" ne pointe pas vers un fichier audio valide sur le serveur.`);\n                _this.loading = false;\n                return;\n              }\n            }\n            // Cas 1: vide\n            // ni fichiers ni URLs\n            // juste un preset vide sans samples\n            if (!hasFiles && urlSamples.length === 0) {\n              // on construit le preset vide\n              const body = {\n                name,\n                type: 'Empty',\n                isFactoryPresets: false,\n                samples: []\n              };\n              // on crée le preset vide sur le back end\n              _this.svc.create(body).subscribe({\n                next: () => {\n                  alert('Preset vide créé.');\n                  _this.loading = false;\n                  _this.router.navigate(['/']);\n                },\n                //gestion des erreurs\n                error: e => {\n                  _this.loading = false;\n                  alert('Erreur lors de la création: ' + (e?.error?.error || e?.message || e));\n                }\n              });\n              return;\n            }\n            // Cas 2: URL seulement\n            // on prend les URLs fournies qui sont celles deja presente sur le back end\n            // et on crée le preset avec ces URLs\n            // on limite à 16 sons max\n            if (!hasFiles) {\n              let samples = urlSamples;\n              if (samples.length > 16) {\n                samples = samples.slice(0, 16);\n                alert('Maximum 16 sons par preset. Les URLs supplémentaires ont été ignorées.');\n              }\n              // on construit le preset complet\n              const body = {\n                name,\n                type: 'Custom',\n                isFactoryPresets: false,\n                samples\n              };\n              // on crée le preset avec les URLs seulement\n              _this.svc.create(body).subscribe({\n                next: () => {\n                  alert('Preset créé avec les URLs fournies.');\n                  _this.loading = false;\n                  _this.router.navigate(['/']);\n                },\n                //gestion des erreurs\n                error: e => {\n                  _this.loading = false;\n                  alert('Erreur lors de la création: ' + (e?.error?.error || e?.message || e));\n                }\n              });\n              return;\n            }\n            // Cas 3: on a des fichiers (avec potentiellement des URL en plus)\n            // on upload les fichiers audio dans un dossier portant le nom du preset\n            // puis on crée le preset avec les URLs résultantes de l'upload + les URLs fournies\n            // dans la limite de 16 sons max\n            _this.svc.upload(name, _this.files).subscribe({\n              next: uploadRes => {\n                const fileSamples = buildSamplesFromUpload(name, uploadRes);\n                let allSamples = [...fileSamples, ...urlSamples];\n                if (allSamples.length > 16) {\n                  allSamples = allSamples.slice(0, 16);\n                  alert('Maximum 16 sons par preset. Certains sons supplémentaires ont été ignorés.');\n                }\n                // on construit le preset complet\n                const body = {\n                  name,\n                  type: 'Custom',\n                  isFactoryPresets: false,\n                  samples: allSamples\n                };\n                // on crée le preset avec les fichiers audio et les URLs fournies\n                _this.svc.create(body).subscribe({\n                  next: () => {\n                    alert('Preset créé avec les fichiers audio et les URLs fournies.');\n                    _this.loading = false;\n                    _this.router.navigate(['/']);\n                  },\n                  //gestion des erreurs\n                  error: e => {\n                    _this.loading = false;\n                    alert('Erreur lors de la création du preset: ' + (e?.error?.error || e?.message || e));\n                  }\n                });\n              },\n              error: e => {\n                console.error(e);\n                _this.loading = false;\n                alert('Erreur lors de l\\'upload des fichiers audio: ' + (e?.error?.error || e?.message || e));\n              }\n            });\n          });\n          return function next(_x) {\n            return _ref.apply(this, arguments);\n          };\n        }(),\n        error: err => {\n          console.error(err);\n          this.loading = false;\n          alert('Impossible de vérifier les presets existants.');\n        }\n      });\n    }\n    static ɵfac = function CreateSamplerComponent_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || CreateSamplerComponent)(i0.ɵɵdirectiveInject(i1.PresetsService), i0.ɵɵdirectiveInject(i2.Router));\n    };\n    static ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: CreateSamplerComponent,\n      selectors: [[\"app-create-sampler\"]],\n      decls: 25,\n      vars: 8,\n      consts: [[\"fileInput\", \"\"], [1, \"example-flex-container\"], [\"for\", \"preset-name\", 1, \"field-label\"], [\"id\", \"preset-name\", \"type\", \"text\", \"placeholder\", \"Mon preset\", 3, \"ngModelChange\", \"ngModel\"], [\"for\", \"preset-urls\", 1, \"field-label\"], [\"id\", \"preset-urls\", \"rows\", \"4\", \"placeholder\", \"Ex: ./MonPreset/kick.wav\", 3, \"ngModelChange\", \"ngModel\"], [1, \"drop-zone\", 3, \"drop\", \"dragover\", \"dragleave\"], [1, \"muted\"], [\"type\", \"button\", 1, \"action\", \"secondary\", 3, \"click\"], [\"type\", \"file\", \"multiple\", \"\", \"accept\", \"audio/*\", \"hidden\", \"\", 3, \"change\"], [\"class\", \"file-list\", 4, \"ngIf\"], [1, \"example-button-row\"], [1, \"action\", 3, \"click\", \"disabled\"], [\"routerLink\", \"/\", 1, \"action\", \"secondary\", 3, \"disabled\"], [\"class\", \"muted\", 4, \"ngIf\"], [1, \"file-list\"], [4, \"ngFor\", \"ngForOf\"], [\"type\", \"button\", 1, \"chip-remove\", 3, \"click\"]],\n      template: function CreateSamplerComponent_Template(rf, ctx) {\n        if (rf & 1) {\n          const _r1 = i0.ɵɵgetCurrentView();\n          i0.ɵɵelementStart(0, \"div\", 1)(1, \"h2\");\n          i0.ɵɵtext(2, \"Cr\\u00E9er un nouveau preset\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(3, \"label\", 2);\n          i0.ɵɵtext(4, \"Nom du preset\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(5, \"input\", 3);\n          i0.ɵɵtwoWayListener(\"ngModelChange\", function CreateSamplerComponent_Template_input_ngModelChange_5_listener($event) {\n            i0.ɵɵrestoreView(_r1);\n            i0.ɵɵtwoWayBindingSet(ctx.name, $event) || (ctx.name = $event);\n            return i0.ɵɵresetView($event);\n          });\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(6, \"label\", 4);\n          i0.ɵɵtext(7, \"URLs des sons (une par ligne, optionnel)\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(8, \"textarea\", 5);\n          i0.ɵɵtwoWayListener(\"ngModelChange\", function CreateSamplerComponent_Template_textarea_ngModelChange_8_listener($event) {\n            i0.ɵɵrestoreView(_r1);\n            i0.ɵɵtwoWayBindingSet(ctx.urlText, $event) || (ctx.urlText = $event);\n            return i0.ɵɵresetView($event);\n          });\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(9, \"div\", 6);\n          i0.ɵɵlistener(\"drop\", function CreateSamplerComponent_Template_div_drop_9_listener($event) {\n            i0.ɵɵrestoreView(_r1);\n            return i0.ɵɵresetView(ctx.onDrop($event));\n          })(\"dragover\", function CreateSamplerComponent_Template_div_dragover_9_listener($event) {\n            i0.ɵɵrestoreView(_r1);\n            return i0.ɵɵresetView(ctx.onDragOver($event));\n          })(\"dragleave\", function CreateSamplerComponent_Template_div_dragleave_9_listener($event) {\n            i0.ɵɵrestoreView(_r1);\n            return i0.ɵɵresetView(ctx.onDragLeave($event));\n          });\n          i0.ɵɵelementStart(10, \"p\");\n          i0.ɵɵtext(11, \"Glissez-d\\u00E9posez des fichiers audio ici\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(12, \"p\", 7);\n          i0.ɵɵtext(13, \"ou\");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(14, \"button\", 8);\n          i0.ɵɵlistener(\"click\", function CreateSamplerComponent_Template_button_click_14_listener() {\n            i0.ɵɵrestoreView(_r1);\n            const fileInput_r2 = i0.ɵɵreference(17);\n            return i0.ɵɵresetView(fileInput_r2.click());\n          });\n          i0.ɵɵtext(15, \" Parcourir le PC\\u2026 \");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(16, \"input\", 9, 0);\n          i0.ɵɵlistener(\"change\", function CreateSamplerComponent_Template_input_change_16_listener($event) {\n            i0.ɵɵrestoreView(_r1);\n            return i0.ɵɵresetView(ctx.onFileSelected($event));\n          });\n          i0.ɵɵelementEnd()();\n          i0.ɵɵtemplate(18, CreateSamplerComponent_ul_18_Template, 2, 1, \"ul\", 10);\n          i0.ɵɵelementStart(19, \"div\", 11)(20, \"button\", 12);\n          i0.ɵɵlistener(\"click\", function CreateSamplerComponent_Template_button_click_20_listener() {\n            i0.ɵɵrestoreView(_r1);\n            return i0.ɵɵresetView(ctx.createPreset());\n          });\n          i0.ɵɵtext(21, \" Cr\\u00E9er le preset \");\n          i0.ɵɵelementEnd();\n          i0.ɵɵelementStart(22, \"button\", 13);\n          i0.ɵɵtext(23, \" Retour \\u00E0 la liste \");\n          i0.ɵɵelementEnd()();\n          i0.ɵɵtemplate(24, CreateSamplerComponent_div_24_Template, 2, 0, \"div\", 14);\n          i0.ɵɵelementEnd();\n        }\n        if (rf & 2) {\n          i0.ɵɵadvance(5);\n          i0.ɵɵtwoWayProperty(\"ngModel\", ctx.name);\n          i0.ɵɵadvance(3);\n          i0.ɵɵtwoWayProperty(\"ngModel\", ctx.urlText);\n          i0.ɵɵadvance();\n          i0.ɵɵclassProp(\"over\", ctx.isDragOver);\n          i0.ɵɵadvance(9);\n          i0.ɵɵproperty(\"ngIf\", ctx.files.length);\n          i0.ɵɵadvance(2);\n          i0.ɵɵproperty(\"disabled\", ctx.loading);\n          i0.ɵɵadvance(2);\n          i0.ɵɵproperty(\"disabled\", ctx.loading);\n          i0.ɵɵadvance(2);\n          i0.ɵɵproperty(\"ngIf\", ctx.loading);\n        }\n      },\n      dependencies: [i3.NgForOf, i3.NgIf, i4.DefaultValueAccessor, i4.NgControlStatus, i4.NgModel, i2.RouterLink],\n      styles: [\".example-flex-container[_ngcontent-%COMP%]{margin-top:4px;display:flex;flex-direction:column;gap:12px}.field-label[_ngcontent-%COMP%]{font-size:.9rem;font-weight:500}input[type=text][_ngcontent-%COMP%], textarea[_ngcontent-%COMP%]{width:100%;padding:8px 10px;border-radius:4px;border:1px solid rgba(0,0,0,.15);font:inherit;box-sizing:border-box}.drop-zone[_ngcontent-%COMP%]{margin-top:8px;padding:16px;border-radius:6px;border:2px dashed rgba(0,0,0,.2);text-align:center;cursor:pointer;transition:background-color .15s ease,border-color .15s ease}.drop-zone.over[_ngcontent-%COMP%]{background-color:#00000008;border-color:#0006}.file-list[_ngcontent-%COMP%]{list-style:none;padding:0;margin:0;display:flex;flex-wrap:wrap;gap:6px}.file-list[_ngcontent-%COMP%]   li[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;background:#0000000a;font-size:.8rem}.chip-remove[_ngcontent-%COMP%]{border:none;background:transparent;cursor:pointer;padding:0 2px;font-size:.9rem}\"]\n    });\n  }\n  return CreateSamplerComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}